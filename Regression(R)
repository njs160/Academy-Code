# COMPLETE NEGATIVE BINOMIAL ANALYSIS WITH ENHANCEMENTS
# =====================================================

# Clear workspace
rm(list = ls())

# Load ALL required libraries first
library(mice)       # For multiple imputation
library(dplyr)      # For data manipulation and pipe operator
library(psych)      # For factor analysis
library(MASS)       # For negative binomial
library(pscl)       # For zero-inflated models
library(lmtest)     # For likelihood ratio tests
library(AER)        # For dispersion tests
library(performance)# For model diagnostics
library(texreg)     # For regression tables
library(ggplot2)    # For visualization
library(car)        # For VIF

# Set the correct path based on your file info
save_path <- "/Users/nasseralsabah/Desktop/PhD/John Jay/Research/Academy/Post-Leoka (Second)/Analysis/R/"

# Verify the file exists
file_path <- paste0(save_path, "Post_ImputedAug2_R.RData")
cat("Checking file at:", file_path, "\n")

if(file.exists(file_path)) {
  cat("✓ File found!\n\n")
  
  # Load the data
  cat("Loading data...\n")
  load(file_path)
  
  # Check what was loaded
  cat("\nObjects loaded:\n")
  print(ls())
  
  # Assign data_imputed to data_final
  if(exists("data_imputed")) {
    data_final <- data_imputed
    cat("\n✓ SUCCESS: Data loaded and assigned to data_final\n")
    cat("Dimensions:", nrow(data_final), "rows x", ncol(data_final), "columns\n")
    
    # Check for multiple imputations
    if(".imp" %in% names(data_final)) {
      cat("Number of imputations:", max(data_final$.imp), "\n")
      cat("Observations per imputation:", nrow(data_final[data_final$.imp == 1, ]), "\n")
    }
    
    cat("\n=== READY TO PROCEED WITH ANALYSIS ===\n")
  } else {
    cat("\nWARNING: data_imputed not found in the loaded file\n")
    cat("Available objects:", paste(ls(), collapse = ", "), "\n")
  }
} else {
  cat("ERROR: File not found at specified path\n")
  cat("Please check the path and try again\n")
}

# Set working directory
setwd(save_path)
cat("\nWorking directory set to:", getwd(), "\n")

#-------------------------------------------
# DEFINE MISSING FUNCTIONS
#-------------------------------------------

pooled_nb_regression_enhanced <- function(mi_data, outcome_var, predictors) {
  # Extract imputed datasets
  n_imp <- max(mi_data$.imp)
  
  # Initialize storage
  model_list <- list()
  theta_values <- numeric(n_imp)
  aic_values <- numeric(n_imp)
  bic_values <- numeric(n_imp)
  
  # Fit model on each imputed dataset
  for(i in 1:n_imp) {
    imp_data <- mi_data[mi_data$.imp == i, ]
    
    # Create formula
    formula_str <- paste(outcome_var, "~", paste(predictors, collapse = " + "))
    formula_obj <- as.formula(formula_str)
    
    tryCatch({
      # Fit negative binomial model
      model <- glm.nb(formula_obj, data = imp_data)
      model_list[[i]] <- model
      theta_values[i] <- model$theta
      aic_values[i] <- AIC(model)
      bic_values[i] <- BIC(model)
    }, error = function(e) {
      cat("  Error in imputation", i, ":", e$message, "\n")
      return(NULL)
    })
  }
  
  # If no models succeeded, return NULL
  if(length(model_list) == 0) {
    return(NULL)
  }
  
  # Pool results using Rubin's rules
  n_params <- length(coef(model_list[[1]]))
  pooled_estimates <- numeric(n_params)
  pooled_se <- numeric(n_params)
  param_names <- names(coef(model_list[[1]]))
  
  # Calculate pooled estimates
  for(j in 1:n_params) {
    # Get estimates from each imputation
    estimates <- sapply(model_list, function(m) if(!is.null(m)) coef(m)[j] else NA)
    variances <- sapply(model_list, function(m) if(!is.null(m)) vcov(m)[j,j] else NA)
    
    # Remove NAs
    valid_estimates <- estimates[!is.na(estimates)]
    valid_variances <- variances[!is.na(variances)]
    n_valid <- length(valid_estimates)
    
    if(n_valid > 0) {
      # Pooled estimate (mean of estimates)
      pooled_estimates[j] <- mean(valid_estimates)
      
      # Within-imputation variance
      within_var <- mean(valid_variances)
      
      # Between-imputation variance
      between_var <- if(n_valid > 1) var(valid_estimates) else 0
      
      # Total variance (Rubin's rules)
      total_var <- within_var + between_var + between_var/n_valid
      pooled_se[j] <- sqrt(total_var)
    } else {
      pooled_estimates[j] <- NA
      pooled_se[j] <- NA
    }
  }
  
  # Create summary dataframe
  summary_df <- data.frame(
    term = param_names,
    estimate = pooled_estimates,
    std.error = pooled_se,
    statistic = pooled_estimates / pooled_se,
    p.value = 2 * pnorm(-abs(pooled_estimates / pooled_se)),
    IRR = exp(pooled_estimates),
    IRR.lower = exp(pooled_estimates - 1.96 * pooled_se),
    IRR.upper = exp(pooled_estimates + 1.96 * pooled_se),
    stringsAsFactors = FALSE
  )
  
  # Add significance stars
  summary_df$stars <- case_when(
    summary_df$p.value < 0.001 ~ "***",
    summary_df$p.value < 0.01 ~ "**",
    summary_df$p.value < 0.05 ~ "*",
    summary_df$p.value < 0.1 ~ "†",
    TRUE ~ ""
  )
  
  # Calculate pseudo R-squared measures
  # Use first imputation for null model
  imp1_data <- mi_data[mi_data$.imp == 1, ]
  null_model <- tryCatch({
    glm.nb(as.formula(paste(outcome_var, "~ 1")), data = imp1_data)
  }, error = function(e) NULL)
  
  if(!is.null(null_model)) {
    # Average log-likelihoods
    avg_loglik_full <- mean(sapply(model_list, function(m) if(!is.null(m)) logLik(m) else NA), na.rm = TRUE)
    loglik_null <- logLik(null_model)
    
    # Pseudo R-squared calculations
    n_obs <- nrow(imp1_data)
    mcfadden <- 1 - (avg_loglik_full / loglik_null)
    cox_snell <- 1 - exp(-2 * (avg_loglik_full - loglik_null) / n_obs)
    nagelkerke <- cox_snell / (1 - exp(2 * loglik_null / n_obs))
  } else {
    mcfadden <- NA
    cox_snell <- NA
    nagelkerke <- NA
    n_obs <- nrow(imp1_data)
  }
  
  # Return results
  return(list(
    summary = summary_df,
    pseudo_r2 = list(
      mcfadden = mcfadden,
      cox_snell = cox_snell,
      nagelkerke = nagelkerke
    ),
    avg_theta = mean(theta_values, na.rm = TRUE),
    avg_aic = mean(aic_values, na.rm = TRUE),
    avg_bic = mean(bic_values, na.rm = TRUE),
    n_obs = n_obs,
    n_imp = n_imp
  ))
}

calculate_vif_imputed <- function(mi_data, predictors, outcome_var) {
  n_imp <- max(mi_data$.imp)
  vif_list <- list()
  
  # Calculate VIF for each imputation
  for(i in 1:n_imp) {
    imp_data <- mi_data[mi_data$.imp == i, ]
    
    # Create formula
    formula_str <- paste(outcome_var, "~", paste(predictors, collapse = " + "))
    formula_obj <- as.formula(formula_str)
    
    tryCatch({
      # Fit linear model for VIF calculation
      lm_model <- lm(formula_obj, data = imp_data)
      
      # Calculate VIF
      vif_values <- vif(lm_model)
      vif_list[[i]] <- vif_values
    }, error = function(e) {
      cat("VIF calculation error in imputation", i, ":", e$message, "\n")
    })
  }
  
  # If no VIF calculations succeeded
  if(length(vif_list) == 0) {
    return(NULL)
  }
  
  # Average VIF across imputations
  all_vars <- names(vif_list[[1]])
  avg_vif <- numeric(length(all_vars))
  
  for(j in 1:length(all_vars)) {
    vif_values <- sapply(vif_list, function(v) if(!is.null(v) && all_vars[j] %in% names(v)) v[all_vars[j]] else NA)
    avg_vif[j] <- mean(vif_values, na.rm = TRUE)
  }
  
  # Create output dataframe
  vif_df <- data.frame(
    Variable = all_vars,
    Avg_VIF = avg_vif,
    stringsAsFactors = FALSE
  )
  
  return(vif_df)
}

# Drop unwanted variables - BUT KEEP STATECODE
drop_vars <- c("train_inserv", "train_special", "train_first", "train_field", "train_lateral", 
               "train_pre", "train_night", "train_reserve", "pos_local", "pos_sher", "pos_camp", 
               "pos_corr", "pos_ranger", "pos_sro", "pos_hwy", "pos_aux", "pos_pre", "pos_nat", 
               "pos_arson", "pos_constable", "pos_transport", "pos_tribe", "pos_mar", "rno_self", 
               "rno_local", "rno_sher", "rno_state", "rno_special", "rno_total")

# Check if statecode exists before dropping variables
if("statecode" %in% names(data_final)) {
  cat("\n✓ statecode variable found in dataset\n")
  cat("Number of unique states:", length(unique(data_final$statecode)), "\n")
} else {
  cat("\n✗ WARNING: statecode variable NOT found in dataset\n")
  cat("Available variables containing 'state':\n")
  state_vars <- names(data_final)[grepl("state", names(data_final), ignore.case = TRUE)]
  if(length(state_vars) > 0) {
    print(state_vars)
  } else {
    cat("No variables containing 'state' found\n")
  }
}

data_final <- data_final[, !names(data_final) %in% drop_vars]

####################################### OUTCOME: LEOKA #######################################

# Create total incidents by weapon type
data_final <- data_final %>%
  mutate(
    total_firearms = total_inj_firearms + total_noninj_firearms,
    total_knife = total_inj_knife + total_noninj_knife,
    total_other = total_inj_other + total_noninj_other,
    total_hands = total_inj_hands + total_noninj_hands
  )

# Create total injuries and incidents
data_final <- data_final %>%
  mutate(
    total_injuries = total_inj_firearms + total_inj_knife + total_inj_other + total_inj_hands,
    total_incidents = total_firearms + total_knife + total_other + total_hands
  )

####################################### PREDICTOR: CLETA #######################################

# Create instructor-to-cadet ratio
data_final$instructor_ratio <- (data_final$ft_total + data_final$pt_total) / data_final$sex_start_total

# Create total training hours across selected subjects
training_subjects <- c("crim", "jjl", "traf_law", "study", "com_part", "cult", "medi", 
                       "prob_solv", "map", "comm", "ethic", "prof", "stress", "cpr", 
                       "comp", "emv", "evid", "intel", "intero", "inv", "pat", "rep", 
                       "traf", "judo", "def_tac", "fire_skill", "nonl", "victim", 
                       "domv", "opioid", "mental", "htraf", "emr", "dui", "gang")

data_final$total_studyhours <- rowSums(data_final[training_subjects], na.rm = TRUE)

# Fail Metrics
data_final$eth_completion_rate <- data_final$eth_comp_total / data_final$eth_start_total
data_final$fail_total <- data_final$fail_total_m + data_final$fail_total_f
data_final$fail_phys_total <- data_final$fail_phys_m + data_final$fail_phys_f
data_final$fail_academic_total <- data_final$fail_acad_m + data_final$fail_acad_f

# Firearm Range recode
data_final$firerange <- as.numeric(data_final$in_fire_1 == 1 | data_final$out_fire_1 == 1)

####################################### CONTROL: UCR data #######################################

data_final$total_clearviolent <- data_final$total_cleared_murder + data_final$total_cleared_robbery + 
                                 data_final$total_cleared_assault + data_final$total_cleared_burglary

data_final$violentclearance_rate <- ifelse(data_final$total_violent > 0, 
                                           (data_final$total_clearviolent / data_final$total_violent) * 100, 
                                           NA)

#-------------------------------------------
# 1) KEEP ONLY NEEDED VARIABLES
#-------------------------------------------

keeplist <- c(
  # Multiple imputation variables
  ".imp", ".id",
  # Core variables
  "total_firearms", "total_knife", "total_other", "total_hands",
  "fail_phys_total", "fail_academic_total", "eth_comp_total", "fail_total",
  "total_inj_hands", "total_inj_knife", "total_inj_firearms", "total_inj_other",
  "total_injuries", "total_incidents",
  "instructor_ratio",
  "basic_lgth_hours", "ft_sworn", "ft_civ", "ebudget", "opbudget", "mean_officers",
  "total_studyhours", "total_violent", "field_man", "environment_3", "agency_type3", "min_ed_bin",
  "fitness_1", "obstacle_1", "firerange", "scenario_1", "refresher",
  "htraf", "emv", "pat", "judo", "def_tac", "fire_skill", "nonl", "acsh",
  "medi", "prob_solv", "lang", "comm", "ethic", "stress", "prof", "hate", "cult",
  "crim", "jjl", "traf_law", "domv", "gang", "victim", "com_part",
  "total_cleared_murder", "total_cleared_robbery", "total_cleared_assault", "total_cleared_burglary",
  "total_clearviolent", "violentclearance_rate",
  "statecode"  # ADDED STATECODE HERE
)

# Keep only variables that exist in the dataset
keeplist <- keeplist[keeplist %in% names(data_final)]
data_final <- data_final[, keeplist]

print("Variables kept:")
print(names(data_final))

# Verify statecode is still there
if("statecode" %in% names(data_final)) {
  cat("\n✓ statecode successfully retained in dataset\n")
} else {
  cat("\n✗ statecode was not retained - it may not exist in the original data\n")
}

#-------------------------------------------
# 2) Z-score standardization
#-------------------------------------------

# Variables to standardize
standardize_vars <- c("basic_lgth_hours", "ft_sworn", "ft_civ", "ebudget", "opbudget", 
                     "mean_officers", "total_studyhours", "total_violent", "total_clearviolent",
                     "fail_phys_total", "fail_academic_total", "fail_total")

# Function to standardize within each imputation
standardize_imputed <- function(data, vars) {
  if(".imp" %in% names(data)) {
    imp_nums <- unique(data$.imp)
  } else {
    imp_nums <- 0
  }
  
  for(var in vars) {
    if(var %in% names(data)) {
      z_var_name <- paste0("z_", var)
      data[[z_var_name]] <- NA
      
      for(imp in imp_nums) {
        if(".imp" %in% names(data)) {
          mask <- data$.imp == imp
        } else {
          mask <- rep(TRUE, nrow(data))
        }
        
        values <- data[[var]][mask]
        if(sum(!is.na(values)) > 1) {
          data[[z_var_name]][mask] <- scale(values)[,1]
        }
      }
    }
  }
  return(data)
}

# Apply standardization
data_final <- standardize_imputed(data_final, standardize_vars)

#-------------------------------------------
# Convert categorical variables to factors
#-------------------------------------------

if("field_man" %in% names(data_final)) {
  data_final$field_man <- as.factor(data_final$field_man)
  if("3" %in% levels(data_final$field_man)) {
    data_final$field_man <- relevel(data_final$field_man, ref = "3")
  }
}

if("environment_3" %in% names(data_final)) {
  data_final$environment_3 <- as.factor(data_final$environment_3)
  if("2" %in% levels(data_final$environment_3)) {
    data_final$environment_3 <- relevel(data_final$environment_3, ref = "2")
  }
}

if("agency_type3" %in% names(data_final)) {
  data_final$agency_type3 <- as.factor(data_final$agency_type3)
}

#-------------------------------------------
# 3) Factor score generation
#-------------------------------------------

# Function to perform factor analysis within each imputation
perform_factor_analysis <- function(data, vars, factor_name) {
  if(".imp" %in% names(data)) {
    imp_nums <- unique(data$.imp)
  } else {
    imp_nums <- 0
  }
  
  data[[factor_name]] <- NA
  
  for(imp in imp_nums) {
    if(".imp" %in% names(data)) {
      mask <- data$.imp == imp
      subset_data <- data[mask, vars, drop = FALSE]
    } else {
      subset_data <- data[, vars, drop = FALSE]
      mask <- rep(TRUE, nrow(data))
    }
    
    complete_cases <- complete.cases(subset_data)
    if(sum(complete_cases) > length(vars)) {
      fa_data <- subset_data[complete_cases, , drop = FALSE]
      
      tryCatch({
        fa_result <- fa(fa_data, nfactors = 1, rotate = "none", scores = "regression")
        factor_scores <- rep(NA, sum(mask))
        factor_scores[complete_cases] <- fa_result$scores[,1]
        data[[factor_name]][mask] <- factor_scores
      }, error = function(e) {
        warning(paste("Factor analysis failed for", factor_name, "in imputation", imp, ":", e$message))
      })
    }
  }
  
  return(data)
}

# Create factors
force_vars <- c("htraf", "emv", "pat", "judo", "def_tac", "fire_skill", "nonl")
force_vars <- force_vars[force_vars %in% names(data_final)]
if(length(force_vars) > 0) {
  data_final <- perform_factor_analysis(data_final, force_vars, "force_based")
}

modern_vars <- c("medi", "prob_solv", "comm", "ethic", "prof")
modern_vars <- modern_vars[modern_vars %in% names(data_final)]
if(length(modern_vars) > 0) {
  data_final <- perform_factor_analysis(data_final, modern_vars, "modern_study")
}

special_vars <- c("jjl", "traf_law", "domv", "victim")
special_vars <- special_vars[special_vars %in% names(data_final)]
if(length(special_vars) > 0) {
  data_final <- perform_factor_analysis(data_final, special_vars, "special_study")
}

#-------------------------------------------
# 4) Define comprehensive predictor list
#-------------------------------------------

preds_full <- c(
  "z_basic_lgth_hours",
  "field_man",
  "environment_3",
  "z_ebudget", 
  "z_opbudget",
  "agency_type3",
  "fitness_1", 
  "obstacle_1", 
  "firerange", 
  "scenario_1", 
  "refresher",
  "force_based", 
  "modern_study", 
  "special_study",
  "z_ft_sworn", 
  "z_ft_civ",
  "min_ed_bin", 
  "z_mean_officers", 
  "z_total_violent",
  "violentclearance_rate",
  "z_fail_phys_total",
  "z_fail_academic_total", 
  "z_fail_total"
)

# Remove any predictors that don't exist
preds_full <- preds_full[preds_full %in% names(data_final)]

print("Final predictors to be used:")
print(preds_full)

#-------------------------------------------
# 5) Cook's D removal of high-influence cases
#-------------------------------------------

dvs <- c("total_firearms", "total_knife", "total_other", "total_hands")
preds_cooksd <- c("z_basic_lgth_hours", "z_ft_sworn", "z_ft_civ", "z_ebudget", "z_opbudget", "z_mean_officers")

dvs <- dvs[dvs %in% names(data_final)]
preds_cooksd <- preds_cooksd[preds_cooksd %in% names(data_final)]

# Cook's D cleaning function
cook_d_cleaning <- function(data, outcomes, predictors) {
  if(".imp" %in% names(data)) {
    imp_nums <- unique(data$.imp)
    imp_nums <- imp_nums[imp_nums > 0]
  } else {
    imp_nums <- 1
    data$.imp <- 1
  }
  
  for(dv in outcomes) {
    if(dv %in% names(data)) {
      print(paste(">>> Processing Cook's D for", dv))
      
      data[[paste0("cooksd_", dv)]] <- NA
      data[[paste0("cleaned_", dv)]] <- data[[dv]]
      
      for(m in imp_nums) {
        mask <- data$.imp == m
        subset_data <- data[mask, c(dv, predictors), drop = FALSE]
        complete_cases <- complete.cases(subset_data)
        
        if(sum(complete_cases) > length(predictors) + 1) {
          N <- sum(complete_cases)
          cutoff <- 4 / N
          
          tryCatch({
            formula_str <- paste(dv, "~", paste(predictors, collapse = " + "))
            model <- lm(as.formula(formula_str), data = subset_data[complete_cases, ])
            cooksd_values <- cooks.distance(model)
            
            cooksd_full <- rep(NA, sum(mask))
            cooksd_full[complete_cases] <- cooksd_values
            data[[paste0("cooksd_", dv)]][mask] <- cooksd_full
            
            high_influence <- cooksd_full > cutoff & !is.na(cooksd_full)
            data[[paste0("cleaned_", dv)]][mask][high_influence] <- NA
            
            print(paste("  Imputation", m, ": Removed", sum(high_influence, na.rm = TRUE), 
                       "high-influence cases out of", N, "(cutoff =", round(cutoff, 6), ")"))
            
          }, error = function(e) {
            warning(paste("Cook's D calculation failed for", dv, "in imputation", m, ":", e$message))
          })
        }
      }
    }
  }
  
  return(data)
}

# Apply Cook's D cleaning
data_final <- cook_d_cleaning(data_final, dvs, preds_cooksd)

# Create cleaned total incidents
data_final$cleaned_total_incidents <- rowSums(data_final[, paste0("cleaned_", dvs)], na.rm = TRUE)

# Define cleaned outcomes
cleaned_outcomes <- paste0("cleaned_", dvs)
cleaned_outcomes <- cleaned_outcomes[cleaned_outcomes %in% names(data_final)]

# COMPREHENSIVE NEGATIVE BINOMIAL ANALYSIS
# =========================================
# All injury and incident types plus totals

#-------------------------------------------
# SETUP AND FUNCTIONS
#-------------------------------------------

# Define all outcomes to analyze
injury_outcomes <- c("total_inj_firearms", "total_inj_knife", "total_inj_other", "total_inj_hands", "total_injuries")
incident_outcomes <- c("cleaned_total_firearms", "cleaned_total_knife", "cleaned_total_other", "cleaned_total_hands", "cleaned_total_incidents")

# Store all results
all_nb_results <- list()

#-------------------------------------------
# RUN ALL MODELS
#-------------------------------------------

cat("\n", strrep("=", 80), "\n")
cat("RUNNING COMPREHENSIVE NEGATIVE BINOMIAL MODELS\n")
cat("Analyzing all injury types, incident types, and totals\n")
cat(strrep("=", 80), "\n")

# 1. Run models for all injury outcomes
cat("\n>>> INJURY MODELS <<<\n")
for(outcome in injury_outcomes) {
  if(outcome %in% names(data_final)) {
    cat("\nAnalyzing:", outcome, "\n")
    
    # Show distribution
    tbl <- table(data_final[[outcome]][data_final$.imp == 1], useNA = "ifany")
    cat("  Zeros:", ifelse("0" %in% names(tbl), tbl["0"], 0), 
        "| Non-zeros:", sum(tbl[names(tbl) != "0"], na.rm = TRUE), "\n")
    
    # Run model
    nb_result <- pooled_nb_regression_enhanced(data_final, outcome, preds_full)
    
    if(!is.null(nb_result)) {
      all_nb_results[[outcome]] <- nb_result
      cat("  ✓ Model completed successfully\n")
    } else {
      cat("  ✗ Model failed\n")
    }
  }
}

# 2. Run models for all incident outcomes
cat("\n>>> INCIDENT MODELS <<<\n")
for(outcome in incident_outcomes) {
  if(outcome %in% names(data_final)) {
    cat("\nAnalyzing:", outcome, "\n")
    
    # Show distribution
    tbl <- table(data_final[[outcome]][data_final$.imp == 1], useNA = "ifany")
    cat("  Zeros:", ifelse("0" %in% names(tbl), tbl["0"], 0), 
        "| Non-zeros:", sum(tbl[names(tbl) != "0"], na.rm = TRUE), "\n")
    
    # Run model
    nb_result <- pooled_nb_regression_enhanced(data_final, outcome, preds_full)
    
    if(!is.null(nb_result)) {
      all_nb_results[[outcome]] <- nb_result
      cat("  ✓ Model completed successfully\n")
    } else {
      cat("  ✗ Model failed\n")
    }
  }
}

#-------------------------------------------
# CREATE COMPREHENSIVE COMPARISON TABLE WITH MCFADDEN'S R²
#-------------------------------------------

create_comprehensive_comparison <- function(results_list) {
  cat("\n\n", strrep("=", 100), "\n")
  cat("COMPREHENSIVE MODEL COMPARISON: ALL INJURY AND INCIDENT TYPES\n")
  cat(strrep("=", 100), "\n")
  
  # Separate injury and incident models
  injury_models <- results_list[names(results_list) %in% c("total_inj_firearms", "total_inj_knife", 
                                                           "total_inj_other", "total_inj_hands", 
                                                           "total_injuries")]
  
  incident_models <- results_list[names(results_list) %in% c("cleaned_total_firearms", "cleaned_total_knife", 
                                                             "cleaned_total_other", "cleaned_total_hands", 
                                                             "cleaned_total_incidents", "cleaned_total_injuries")]
  
  # Get all unique predictors
  all_predictors <- c()
  for(model_name in names(results_list)) {
    if(!is.null(results_list[[model_name]])) {
      all_predictors <- unique(c(all_predictors, results_list[[model_name]]$summary$term))
    }
  }
  all_predictors <- all_predictors[all_predictors != "(Intercept)"]
  all_predictors <- sort(all_predictors)
  
  # Print header for injuries
  if(length(injury_models) > 0) {
    cat("\n--- INJURY MODELS ---\n")
    cat(strrep("-", 100), "\n")
    cat(sprintf("%-30s", "Predictor"))
    for(outcome in names(injury_models)) {
      short_name <- gsub("total_inj_|total_", "", outcome)
      cat(sprintf(" %15s", short_name))
    }
    cat("\n")
    cat(strrep("-", 100), "\n")
    
    # Print IRRs for injury models
    for(pred in all_predictors) {
      cat(sprintf("%-30s", substr(pred, 1, 30)))
      
      for(outcome in names(injury_models)) {
        if(!is.null(injury_models[[outcome]])) {
          sum_df <- injury_models[[outcome]]$summary
          pred_row <- sum_df[sum_df$term == pred, ]
          
          if(nrow(pred_row) > 0) {
            irr_str <- sprintf("%.3f%s", pred_row$IRR[1], pred_row$stars[1])
            cat(sprintf(" %15s", irr_str))
          } else {
            cat(sprintf(" %15s", "-"))
          }
        } else {
          cat(sprintf(" %15s", "NA"))
        }
      }
      cat("\n")
    }
    
    # Model fit for injuries - INCLUDING MCFADDEN'S R²
    cat(strrep("-", 100), "\n")
    cat(sprintf("%-30s", "McFadden R²"))
    for(outcome in names(injury_models)) {
      if(!is.null(injury_models[[outcome]])) {
        cat(sprintf(" %15.3f", injury_models[[outcome]]$pseudo_r2$mcfadden))
      } else {
        cat(sprintf(" %15s", "NA"))
      }
    }
    cat("\n")
    
    cat(sprintf("%-30s", "Nagelkerke R²"))
    for(outcome in names(injury_models)) {
      if(!is.null(injury_models[[outcome]])) {
        cat(sprintf(" %15.3f", injury_models[[outcome]]$pseudo_r2$nagelkerke))
      } else {
        cat(sprintf(" %15s", "NA"))
      }
    }
    cat("\n")
    
    cat(sprintf("%-30s", "N"))
    for(outcome in names(injury_models)) {
      if(!is.null(injury_models[[outcome]])) {
        cat(sprintf(" %15.0f", injury_models[[outcome]]$n_obs))
      } else {
        cat(sprintf(" %15s", "NA"))
      }
    }
    cat("\n")
  }
  
  # Print header for incidents
  if(length(incident_models) > 0) {
    cat("\n\n--- INCIDENT MODELS ---\n")
    cat(strrep("-", 100), "\n")
    cat(sprintf("%-30s", "Predictor"))
    for(outcome in names(incident_models)) {
      short_name <- gsub("cleaned_total_|cleaned_|total_", "", outcome)
      cat(sprintf(" %15s", short_name))
    }
    cat("\n")
    cat(strrep("-", 100), "\n")
    
    # Print IRRs for incident models
    for(pred in all_predictors) {
      cat(sprintf("%-30s", substr(pred, 1, 30)))
      
      for(outcome in names(incident_models)) {
        if(!is.null(incident_models[[outcome]])) {
          sum_df <- incident_models[[outcome]]$summary
          pred_row <- sum_df[sum_df$term == pred, ]
          
          if(nrow(pred_row) > 0) {
            irr_str <- sprintf("%.3f%s", pred_row$IRR[1], pred_row$stars[1])
            cat(sprintf(" %15s", irr_str))
          } else {
            cat(sprintf(" %15s", "-"))
          }
        } else {
          cat(sprintf(" %15s", "NA"))
        }
      }
      cat("\n")
    }
    
    # Model fit for incidents - INCLUDING MCFADDEN'S R²
    cat(strrep("-", 100), "\n")
    cat(sprintf("%-30s", "McFadden R²"))
    for(outcome in names(incident_models)) {
      if(!is.null(incident_models[[outcome]])) {
        cat(sprintf(" %15.3f", incident_models[[outcome]]$pseudo_r2$mcfadden))
      } else {
        cat(sprintf(" %15s", "NA"))
      }
    }
    cat("\n")
    
    cat(sprintf("%-30s", "Nagelkerke R²"))
    for(outcome in names(incident_models)) {
      if(!is.null(incident_models[[outcome]])) {
        cat(sprintf(" %15.3f", incident_models[[outcome]]$pseudo_r2$nagelkerke))
      } else {
        cat(sprintf(" %15s", "NA"))
      }
    }
    cat("\n")
    
    cat(sprintf("%-30s", "N"))
    for(outcome in names(incident_models)) {
      if(!is.null(incident_models[[outcome]])) {
        cat(sprintf(" %15.0f", incident_models[[outcome]]$n_obs))
      } else {
        cat(sprintf(" %15s", "NA"))
      }
    }
    cat("\n")
  }
  
  cat(strrep("-", 100), "\n")
  cat("Significance: *** p<0.001, ** p<0.01, * p<0.05, † p<0.1\n")
}

# Create the comprehensive comparison
if(length(all_nb_results) > 0) {
  create_comprehensive_comparison(all_nb_results)
}

#-------------------------------------------
# VIF FOR POOLED MODEL
#-------------------------------------------

cat("\n\n", strrep("=", 80), "\n")
cat("VARIANCE INFLATION FACTORS (VIF) - POOLED MODEL\n")
cat(strrep("=", 80), "\n")

# Calculate VIF using total incidents as outcome
if("cleaned_total_incidents" %in% names(data_final)) {
  vif_pooled <- calculate_vif_imputed(data_final, preds_full, "cleaned_total_incidents")
  
  if(!is.null(vif_pooled)) {
    cat("\nVIF Summary (averaged across all imputations):\n")
    cat(strrep("-", 60), "\n")
    
    # Show all VIF values sorted
    vif_pooled <- vif_pooled[order(vif_pooled$Avg_VIF, decreasing = TRUE), ]
    
    for(i in 1:nrow(vif_pooled)) {
      cat(sprintf("%-30s: %6.3f", vif_pooled$Variable[i], vif_pooled$Avg_VIF[i]))
      if(vif_pooled$Avg_VIF[i] > 10) {
        cat(" ***")
      } else if(vif_pooled$Avg_VIF[i] > 5) {
        cat(" **")
      }
      cat("\n")
    }
    
    cat(strrep("-", 60), "\n")
    cat("Note: *** = VIF > 10 (severe), ** = VIF > 5 (moderate)\n")
    
    # Quick summary
    cat("\nMulticollinearity Summary:\n")
    cat("- Highest VIF:", round(max(vif_pooled$Avg_VIF), 3), 
        "(", vif_pooled$Variable[1], ")\n")
    cat("- Variables with VIF > 10:", sum(vif_pooled$Avg_VIF > 10), "\n")
    cat("- Variables with VIF > 5:", sum(vif_pooled$Avg_VIF > 5), "\n")
  }
}

#-------------------------------------------
# EXPORT ALL RESULTS
#-------------------------------------------

# Export comprehensive results
if(length(all_nb_results) > 0) {
  all_results_df <- data.frame()
  
  for(outcome in names(all_nb_results)) {
    if(!is.null(all_nb_results[[outcome]])) {
      df <- all_nb_results[[outcome]]$summary
      df$outcome <- outcome
      df$outcome_type <- ifelse(grepl("inj", outcome), "Injury", "Incident")
      df$weapon_type <- case_when(
        grepl("firearms", outcome) ~ "Firearms",
        grepl("knife", outcome) ~ "Knife",
        grepl("other", outcome) ~ "Other",
        grepl("hands", outcome) ~ "Hands",
        grepl("injuries", outcome) ~ "Total",
        grepl("incidents", outcome) ~ "Total",
        TRUE ~ "Unknown"
      )
      df$pseudo_r2_nagelkerke <- all_nb_results[[outcome]]$pseudo_r2$nagelkerke
      df$pseudo_r2_mcfadden <- all_nb_results[[outcome]]$pseudo_r2$mcfadden
      df$pseudo_r2_cox_snell <- all_nb_results[[outcome]]$pseudo_r2$cox_snell
      df$theta <- all_nb_results[[outcome]]$avg_theta
      df$aic <- all_nb_results[[outcome]]$avg_aic
      df$bic <- all_nb_results[[outcome]]$avg_bic
      df$n_obs <- all_nb_results[[outcome]]$n_obs
      
      all_results_df <- rbind(all_results_df, df)
    }
  }
  
  write.csv(all_results_df, 
            paste0(save_path, "nb_comprehensive_all_outcomes_results.csv"), 
            row.names = FALSE)
  
  cat("\n\n✓ Comprehensive results exported to: nb_comprehensive_all_outcomes_results.csv\n")
}

#-------------------------------------------
# CREATE SUMMARY STATISTICS TABLE
#-------------------------------------------

cat("\n\n", strrep("=", 80), "\n")
cat("SUMMARY STATISTICS FOR ALL OUTCOMES\n")
cat(strrep("=", 80), "\n")

# Create summary stats
summary_stats <- data.frame(
  Outcome = character(),
  Type = character(),
  Mean = numeric(),
  SD = numeric(),
  Min = numeric(),
  Max = numeric(),
  Zeros = numeric(),
  N = numeric()
)

# Calculate for all outcomes
all_outcomes <- c(injury_outcomes, incident_outcomes)
for(outcome in all_outcomes) {
  if(outcome %in% names(data_final)) {
    # Use first imputation for summary stats
    outcome_data <- data_final[[outcome]][data_final$.imp == 1]
    
    summary_stats <- rbind(summary_stats, data.frame(
      Outcome = outcome,
      Type = ifelse(grepl("inj", outcome), "Injury", "Incident"),
      Mean = round(mean(outcome_data, na.rm = TRUE), 2),
      SD = round(sd(outcome_data, na.rm = TRUE), 2),
      Min = min(outcome_data, na.rm = TRUE),
      Max = max(outcome_data, na.rm = TRUE),
      Zeros = sum(outcome_data == 0, na.rm = TRUE),
      N = sum(!is.na(outcome_data))
    ))
  }
}

print(summary_stats)

# Save summary statistics
write.csv(summary_stats, 
          paste0(save_path, "nb_outcome_summary_statistics.csv"), 
          row.names = FALSE)

#-------------------------------------------
# CREATE VISUALIZATION OF KEY PREDICTORS
#-------------------------------------------

# Function to create a heatmap-style visualization
create_irr_heatmap <- function(results_list, top_n = 15) {
  # Extract significant predictors across all models
  sig_data <- data.frame()
  
  for(outcome in names(results_list)) {
    if(!is.null(results_list[[outcome]])) {
      df <- results_list[[outcome]]$summary
      df <- df[df$p.value < 0.05 & df$term != "(Intercept)", ]
      if(nrow(df) > 0) {
        df$outcome <- outcome
        df$outcome_clean <- gsub("cleaned_total_|total_inj_|total_", "", outcome)
        df$log_irr <- log(df$IRR)
        sig_data <- rbind(sig_data, df[, c("term", "outcome_clean", "IRR", "log_irr", "p.value")])
      }
    }
  }
  
  if(nrow(sig_data) > 0) {
    # Get top predictors by average absolute effect
    top_preds <- sig_data %>%
      group_by(term) %>%
      summarise(avg_abs_effect = mean(abs(log_irr))) %>%
      arrange(desc(avg_abs_effect)) %>%
      head(top_n) %>%
      pull(term)
    
    # Filter to top predictors
    plot_data <- sig_data[sig_data$term %in% top_preds, ]
    
    # Clean names
    plot_data$term_clean <- gsub("z_", "", plot_data$term)
    plot_data$term_clean <- gsub("_", " ", plot_data$term_clean)
    plot_data$term_clean <- gsub("agency type32", "Agency: College", plot_data$term_clean)
    plot_data$term_clean <- gsub("agency type33", "Agency: Other", plot_data$term_clean)
    plot_data$term_clean <- gsub("total clearviolent", "Violent Crimes Cleared", plot_data$term_clean)
    plot_data$term_clean <- gsub("mean officers", "Mean Officers", plot_data$term_clean)
    plot_data$term_clean <- gsub("ft sworn", "FT Sworn Instructors", plot_data$term_clean)
    
    # Create plot
    p <- ggplot(plot_data, aes(x = outcome_clean, y = term_clean, fill = log_irr)) +
      geom_tile(color = "white", size = 0.5) +
      geom_text(aes(label = sprintf("%.2f", IRR)), size = 3) +
      scale_fill_gradient2(low = "#2166AC", mid = "white", high = "#B2182B",
                          midpoint = 0, limits = c(-1.5, 1.5),
                          name = "Log(IRR)") +
      labs(title = "Significant Predictors Across All Models",
           subtitle = "Numbers show Incident Rate Ratios (p < 0.05)",
           x = "Outcome Type",
           y = NULL) +
      theme_minimal() +
      theme(axis.text.x = element_text(angle = 45, hjust = 1),
            plot.title = element_text(hjust = 0.5, face = "bold"),
            plot.subtitle = element_text(hjust = 0.5))
    
    ggsave(paste0(save_path, "irr_heatmap_all_models.png"), 
           p, width = 12, height = 8, dpi = 300)
    
    cat("\n✓ IRR heatmap saved: irr_heatmap_all_models.png\n")
  }
}

# Create the visualization
if(length(all_nb_results) > 0) {
  create_irr_heatmap(all_nb_results)
}

# =================================================
# STATE EFFECTS ANALYSIS
# =================================================

cat("\n\n", strrep("=", 80), "\n")
cat("STATE EFFECTS ANALYSIS\n")
cat(strrep("=", 80), "\n")

# First check if statecode exists in the data
if("statecode" %in% names(data_final)) {
  
  # Convert statecode to factor if it isn't already
  data_final$statecode <- as.factor(data_final$statecode)
  
  # Check number of states
  n_states <- length(unique(data_final$statecode[!is.na(data_final$statecode)]))
  cat("\nNumber of states in data:", n_states, "\n")
  
  # Create predictor list with state effects
  preds_with_state <- c(preds_full, "statecode")
  
  # Store state effects results
  state_effects_results <- list()
  
  cat("\n>>> RUNNING MODELS WITH STATE FIXED EFFECTS <<<\n")
  cat("Note: This may take longer due to additional parameters\n\n")
  
  # Run models for key outcomes only (to save time)
  key_outcomes <- c("total_injuries", "cleaned_total_incidents", 
                    "total_inj_firearms", "cleaned_total_firearms")
  
  for(outcome in key_outcomes) {
    if(outcome %in% names(data_final)) {
      cat("\nAnalyzing with state effects:", outcome, "\n")
      
      # Show distribution
      tbl <- table(data_final[[outcome]][data_final$.imp == 1], useNA = "ifany")
      cat("  Zeros:", ifelse("0" %in% names(tbl), tbl["0"], 0), 
          "| Non-zeros:", sum(tbl[names(tbl) != "0"], na.rm = TRUE), "\n")
      
      # Run model with state effects
      nb_state_result <- pooled_nb_regression_enhanced(data_final, outcome, preds_with_state)
      
      if(!is.null(nb_state_result)) {
        state_effects_results[[outcome]] <- nb_state_result
        cat("  ✓ State effects model completed successfully\n")
        
        # Compare with base model
        if(outcome %in% names(all_nb_results)) {
          base_r2 <- all_nb_results[[outcome]]$pseudo_r2$mcfadden
          state_r2 <- nb_state_result$pseudo_r2$mcfadden
          r2_improvement <- state_r2 - base_r2
          
          cat("  McFadden R² comparison:\n")
          cat("    Base model: ", sprintf("%.4f", base_r2), "\n")
          cat("    State model:", sprintf("%.4f", state_r2), "\n")
          cat("    Improvement:", sprintf("%.4f", r2_improvement), 
              "(", sprintf("%.1f%%", (r2_improvement/base_r2)*100), ")\n")
        }
      } else {
        cat("  ✗ State effects model failed\n")
      }
    }
  }
  
  # Create comparison table
  if(length(state_effects_results) > 0) {
    cat("\n\n", strrep("=", 80), "\n")
    cat("MODEL COMPARISON: BASE vs. STATE FIXED EFFECTS\n")
    cat(strrep("=", 80), "\n")
    
    comparison_df <- data.frame(
      Outcome = character(),
      Base_McFadden = numeric(),
      State_McFadden = numeric(),
      Improvement = numeric(),
      Base_Nagelkerke = numeric(),
      State_Nagelkerke = numeric(),
      Base_AIC = numeric(),
      State_AIC = numeric(),
      stringsAsFactors = FALSE
    )
    
    for(outcome in names(state_effects_results)) {
      if(outcome %in% names(all_nb_results)) {
        base_model <- all_nb_results[[outcome]]
        state_model <- state_effects_results[[outcome]]
        
        comparison_df <- rbind(comparison_df, data.frame(
          Outcome = outcome,
          Base_McFadden = base_model$pseudo_r2$mcfadden,
          State_McFadden = state_model$pseudo_r2$mcfadden,
          Improvement = state_model$pseudo_r2$mcfadden - base_model$pseudo_r2$mcfadden,
          Base_Nagelkerke = base_model$pseudo_r2$nagelkerke,
          State_Nagelkerke = state_model$pseudo_r2$nagelkerke,
          Base_AIC = base_model$avg_aic,
          State_AIC = state_model$avg_aic,
          stringsAsFactors = FALSE
        ))
      }
    }
    
    print(comparison_df)
    
    # Save comparison
    write.csv(comparison_df, 
              paste0(save_path, "state_effects_comparison.csv"), 
              row.names = FALSE)
    
    # Extract key predictors comparison
    cat("\n\n", strrep("=", 80), "\n")
    cat("KEY PREDICTORS: BASE vs. STATE MODELS\n")
    cat(strrep("=", 80), "\n")
    cat("Showing how IRRs change when controlling for state effects\n\n")
    
    # Focus on a few key predictors
    key_preds <- c("z_basic_lgth_hours", "force_based", "modern_study", 
                   "z_fail_total", "violentclearance_rate")
    
    for(pred in key_preds) {
      cat("\n", pred, ":\n")
      cat(sprintf("%-25s %10s %10s %10s\n", "Outcome", "Base IRR", "State IRR", "Change"))
      cat(strrep("-", 60), "\n")
      
      for(outcome in names(state_effects_results)) {
        if(outcome %in% names(all_nb_results)) {
          base_sum <- all_nb_results[[outcome]]$summary
          state_sum <- state_effects_results[[outcome]]$summary
          
          base_row <- base_sum[base_sum$term == pred, ]
          state_row <- state_sum[state_sum$term == pred, ]
          
          if(nrow(base_row) > 0 && nrow(state_row) > 0) {
            cat(sprintf("%-25s %10.3f%s %10.3f%s %10.1f%%\n",
                       gsub("cleaned_total_|total_", "", outcome),
                       base_row$IRR[1], base_row$stars[1],
                       state_row$IRR[1], state_row$stars[1],
                       ((state_row$IRR[1] - base_row$IRR[1])/base_row$IRR[1])*100))
          }
        }
      }
    }
    
    # Save full state effects results
    state_results_df <- data.frame()
    
    for(outcome in names(state_effects_results)) {
      if(!is.null(state_effects_results[[outcome]])) {
        df <- state_effects_results[[outcome]]$summary
        df$outcome <- outcome
        df <- df[!grepl("statecode", df$term), ]  # Remove individual state coefficients
        state_results_df <- rbind(state_results_df, df)
      }
    }
    
    write.csv(state_results_df, 
              paste0(save_path, "nb_state_effects_results.csv"), 
              row.names = FALSE)
    
    cat("\n\n✓ State effects analysis complete\n")
    cat("✓ Files created:\n")
    cat("  - state_effects_comparison.csv\n")
    cat("  - nb_state_effects_results.csv\n")
  }
  
} else {
  cat("\nWARNING: 'statecode' variable not found in dataset\n")
  cat("Cannot perform state effects analysis\n")
}

# Update the final summary message
cat("\n\n", strrep("=", 80), "\n")
cat("COMPREHENSIVE ANALYSIS COMPLETE\n")
cat(strrep("=", 80), "\n")
cat("\nFiles created:\n")
cat("- nb_comprehensive_all_outcomes_results.csv (includes McFadden R²)\n")
cat("- nb_outcome_summary_statistics.csv\n")
cat("- irr_heatmap_all_models.png\n")
if("statecode" %in% names(data_final)) {
  cat("- state_effects_comparison.csv\n")
  cat("- nb_state_effects_results.csv\n")
  
  
# Close the current if-statement
}

# Create regions based on actual state abbreviations
# Using Census Bureau regional classifications

# Define the regions
northeast <- c("CT", "ME", "MA", "NH", "RI", "VT", "NJ", "NY", "PA")
midwest <- c("IL", "IN", "MI", "OH", "WI", "IA", "KS", "MN", "MO", "NE", "ND", "SD")
south <- c("DE", "FL", "GA", "MD", "NC", "SC", "VA", "WV", "DC", "AL", "KY", "MS", "TN", "AR", "LA", "OK", "TX")
west <- c("AZ", "CO", "ID", "MT", "NV", "NM", "UT", "WY", "AK", "CA", "HI", "OR", "WA")

# Create region variable
data_final$region <- case_when(
  data_final$statecode %in% northeast ~ "Northeast",
  data_final$statecode %in% midwest ~ "Midwest",
  data_final$statecode %in% south ~ "South",
  data_final$statecode %in% west ~ "West",
  TRUE ~ "Unknown"
)

# Convert to factor with South as reference (largest region)
data_final$region <- factor(data_final$region, levels = c("South", "Northeast", "Midwest", "West"))

# Check the regional distribution
cat("\nRegional distribution:\n")
print(table(data_final$region[data_final$.imp == 1]))

# Now run regional models
cat("\n>>> RUNNING MODELS WITH REGIONAL FIXED EFFECTS <<<\n\n")

# Define what we're testing
outcomes <- c("total_injuries", "cleaned_total_incidents")
predictors <- c("z_basic_lgth_hours", "force_based", "modern_study", 
                "z_fail_total", "violentclearance_rate")

# Store results
regional_results <- list()

# Run models
for(outcome in outcomes) {
  cat("Analyzing with regional effects:", outcome, "\n")
  
  # Show distribution
  tbl <- table(data_final[[outcome]][data_final$.imp == 1], useNA = "ifany")
  cat("  Zeros:", ifelse("0" %in% names(tbl), tbl["0"], 0), 
      "| Non-zeros:", sum(tbl[names(tbl) != "0"], na.rm = TRUE), "\n")
  
  # Run model with regions
  regional_result <- pooled_nb_regression_enhanced(
    data_final, 
    outcome, 
    c(predictors, "region")
  )
  
  if(!is.null(regional_result)) {
    regional_results[[outcome]] <- regional_result
    cat("  ✓ Regional effects model completed successfully\n")
    cat("  McFadden R²:", sprintf("%.4f", regional_result$pseudo_r2$mcfadden), "\n\n")
  } else {
    cat("  ✗ Regional effects model failed\n\n")
  }
}

# Display results
if(length(regional_results) > 0) {
  cat("\n", strrep("=", 80), "\n")
  cat("MODEL COMPARISON: BASE vs. STATE vs. REGIONAL FIXED EFFECTS\n")
  cat(strrep("=", 80), "\n\n")
  
  # Create comparison table
  for(outcome in names(regional_results)) {
    if(outcome %in% names(all_nb_results) && 
       outcome %in% names(state_effects_results)) {
      
      base_r2 <- all_nb_results[[outcome]]$pseudo_r2$mcfadden
      state_r2 <- state_effects_results[[outcome]]$pseudo_r2$mcfadden
      regional_r2 <- regional_results[[outcome]]$pseudo_r2$mcfadden
      
      cat(outcome, ":\n")
      cat("  Base McFadden R²:     ", sprintf("%.4f", base_r2), "\n")
      cat("  Regional McFadden R²: ", sprintf("%.4f", regional_r2), 
          " (", sprintf("%+.1f%%", ((regional_r2 - base_r2)/base_r2)*100), ")\n")
      cat("  State McFadden R²:    ", sprintf("%.4f", state_r2), 
          " (", sprintf("%+.1f%%", ((state_r2 - base_r2)/base_r2)*100), ")\n\n")
    }
  }
  
  # Show regional effects
  cat(strrep("=", 80), "\n")
  cat("REGIONAL EFFECTS (IRRs relative to South)\n")
  cat(strrep("=", 80), "\n")
  
  for(outcome in names(regional_results)) {
    cat("\n", outcome, ":\n")
    summary_df <- regional_results[[outcome]]$summary
    region_rows <- summary_df[grepl("^region", summary_df$term), ]
    
    if(nrow(region_rows) > 0) {
      print(region_rows[, c("term", "IRR", "IRR.lower", "IRR.upper", "p.value", "stars")])
    }
  }
}

# Show which states are in which regions for verification
cat("\n\nStates by Region:\n")
cat("================\n")
for(reg in c("Northeast", "Midwest", "South", "West")) {
  states_in_region <- unique(data_final$statecode[data_final$region == reg & data_final$.im
  
 # Re-run regional analysis with FULL predictor set for fair comparison
cat("\n=== REGIONAL ANALYSIS WITH FULL PREDICTORS ===\n\n")

# Run models with all predictors plus region
regional_full_results <- list()

for(outcome in c("total_injuries", "cleaned_total_incidents")) {
  cat("Analyzing", outcome, "with full predictors + regional effects\n")
  
  # Run model with ALL predictors plus region
  result <- pooled_nb_regression_enhanced(
    data_final, 
    outcome, 
    c(preds_full, "region")
  )
  
  if(!is.null(result)) {
    regional_full_results[[outcome]] <- result
    cat("✓ Model completed. McFadden R²:", round(result$pseudo_r2$mcfadden, 4), "\n")
    
    # Compare with base model
    if(outcome %in% names(all_nb_results)) {
      base_r2 <- all_nb_results[[outcome]]$pseudo_r2$mcfadden
      improvement <- result$pseudo_r2$mcfadden - base_r2
      pct_imp <- (improvement / base_r2) * 100
      cat("  Base R²:", round(base_r2, 4), 
          "| Improvement:", round(improvement, 4),
          "(", sprintf("%+.1f%%", pct_imp), ")\n\n")
    }
  }
}

# Create comprehensive comparison
cat("\n", strrep("=", 80), "\n")
cat("FAIR MODEL COMPARISON: All Models with Same Predictors\n")
cat(strrep("=", 80), "\n\n")

for(outcome in names(regional_full_results)) {
  if(outcome %in% names(all_nb_results) && 
     outcome %in% names(state_effects_results)) {
    
    base_r2 <- all_nb_results[[outcome]]$pseudo_r2$mcfadden
    regional_sparse_r2 <- regional_results[[outcome]]$pseudo_r2$mcfadden
    regional_full_r2 <- regional_full_results[[outcome]]$pseudo_r2$mcfadden
    state_r2 <- state_effects_results[[outcome]]$pseudo_r2$mcfadden
    
    cat(outcome, ":\n")
    cat("  Base (full predictors):        ", sprintf("%.4f", base_r2), "\n")
    cat("  Regional (5 predictors only):  ", sprintf("%.4f", regional_sparse_r2), 
        sprintf(" (%+.1f%%)", ((regional_sparse_r2 - base_r2)/base_r2)*100), "\n")
    cat("  Regional (full predictors):    ", sprintf("%.4f", regional_full_r2), 
        sprintf(" (%+.1f%%)", ((regional_full_r2 - base_r2)/base_r2)*100), "\n")
    cat("  State (full predictors):       ", sprintf("%.4f", state_r2), 
        sprintf(" (%+.1f%%)", ((state_r2 - base_r2)/base_r2)*100), "\n\n")
  }
}

# Show regional effects from full model
cat(strrep("=", 80), "\n")
cat("REGIONAL EFFECTS FROM FULL MODEL (IRRs relative to South)\n")
cat(strrep("=", 80), "\n")

for(outcome in names(regional_full_results)) {
  cat("\n", outcome, ":\n")
  summary_df <- regional_full_results[[outcome]]$summary
  region_rows <- summary_df[grepl("^region", summary_df$term), ]
  
  if(nrow(region_rows) > 0) {
    print(region_rows[, c("term", "IRR", "IRR.lower", "IRR.upper", "p.value", "stars")])
  }
}

# === ADD REGIONAL EFFECTS TO ALL MODELS ===
cat("\n\n", strrep("=", 80), "\n")
cat("RUNNING REGIONAL MODELS FOR ALL INJURY AND INCIDENT TYPES\n")
cat(strrep("=", 80), "\n\n")

# Define all outcomes
injury_outcomes <- c("total_inj_firearms", "total_inj_knife", "total_inj_other", "total_inj_hands", "total_injuries")
incident_outcomes <- c("cleaned_total_firearms", "cleaned_total_knife", "cleaned_total_other", "cleaned_total_hands", "cleaned_total_incidents")

# Store regional results
regional_all_results <- list()

# Run regional models for all outcomes
for(outcome in c(injury_outcomes, incident_outcomes)) {
  if(outcome %in% names(data_final)) {
    cat("Analyzing:", outcome, "with regional effects\n")
    
    # Run model with full predictors + region
    result <- pooled_nb_regression_enhanced(
      data_final, 
      outcome, 
      c(preds_full, "region")
    )
    
    if(!is.null(result)) {
      regional_all_results[[outcome]] <- result
      cat("  ✓ Completed. McFadden R²:", sprintf("%.3f", result$pseudo_r2$mcfadden))
      
      # Compare with base
      if(outcome %in% names(all_nb_results)) {
        base_r2 <- all_nb_results[[outcome]]$pseudo_r2$mcfadden
        improvement <- ((result$pseudo_r2$mcfadden - base_r2) / base_r2) * 100
        cat(sprintf(" (%+.1f%% vs base)", improvement))
      }
      cat("\n")
    } else {
      cat("  ✗ Model failed\n")
    }
  }
}

# Create enhanced comparison table
create_enhanced_comparison <- function(base_results, regional_results) {
  cat("\n\n", strrep("=", 100), "\n")
  cat("COMPREHENSIVE MODEL COMPARISON: BASE vs. REGIONAL FIXED EFFECTS\n")
  cat(strrep("=", 100), "\n")
  
  # Separate by type
  injury_models <- list()
  incident_models <- list()
  
  for(name in names(regional_results)) {
    if(grepl("inj", name)) {
      injury_models[[name]] <- regional_results[[name]]
    } else {
      incident_models[[name]] <- regional_results[[name]]
    }
  }
  
  # Get all predictors
  all_predictors <- unique(unlist(lapply(regional_results, function(x) x$summary$term)))
  all_predictors <- all_predictors[!all_predictors %in% c("(Intercept)", "regionNortheast", "regionMidwest", "regionWest")]
  all_predictors <- sort(all_predictors)
  
  # Print INJURY models
  if(length(injury_models) > 0) {
    cat("\n--- INJURY MODELS (with Regional Effects) ---\n")
    cat(strrep("-", 100), "\n")
    cat(sprintf("%-30s", "Predictor"))
    for(outcome in names(injury_models)) {
      short_name <- gsub("total_inj_|total_", "", outcome)
      cat(sprintf(" %15s", short_name))
    }
    cat("\n")
    cat(strrep("-", 100), "\n")
    
    # Print IRRs
    for(pred in all_predictors) {
      cat(sprintf("%-30s", substr(pred, 1, 30)))
      
      for(outcome in names(injury_models)) {
        if(!is.null(injury_models[[outcome]])) {
          sum_df <- injury_models[[outcome]]$summary
          pred_row <- sum_df[sum_df$term == pred, ]
          
          if(nrow(pred_row) > 0) {
            irr_str <- sprintf("%.3f%s", pred_row$IRR[1], pred_row$stars[1])
            cat(sprintf(" %15s", irr_str))
          } else {
            cat(sprintf(" %15s", "-"))
          }
        }
      }
      cat("\n")
    }
    
    # Add regional effects
    cat(strrep("-", 100), "\n")
    cat("REGIONAL EFFECTS:\n")
    for(reg in c("regionNortheast", "regionMidwest", "regionWest")) {
      cat(sprintf("%-30s", gsub("region", "", reg)))
      for(outcome in names(injury_models)) {
        sum_df <- injury_models[[outcome]]$summary
        pred_row <- sum_df[sum_df$term == reg, ]
        if(nrow(pred_row) > 0) {
          irr_str <- sprintf("%.3f%s", pred_row$IRR[1], pred_row$stars[1])
          cat(sprintf(" %15s", irr_str))
        } else {
          cat(sprintf(" %15s", "-"))
        }
      }
      cat("\n")
    }
    
    # Model fit comparison
    cat(strrep("-", 100), "\n")
    cat(sprintf("%-30s", "Base McFadden R²"))
    for(outcome in names(injury_models)) {
      if(outcome %in% names(base_results)) {
        cat(sprintf(" %15.3f", base_results[[outcome]]$pseudo_r2$mcfadden))
      }
    }
    cat("\n")
    
    cat(sprintf("%-30s", "Regional McFadden R²"))
    for(outcome in names(injury_models)) {
      cat(sprintf(" %15.3f", injury_models[[outcome]]$pseudo_r2$mcfadden))
    }
    cat("\n")
    
    cat(sprintf("%-30s", "Improvement"))
    for(outcome in names(injury_models)) {
      if(outcome %in% names(base_results)) {
        base_r2 <- base_results[[outcome]]$pseudo_r2$mcfadden
        reg_r2 <- injury_models[[outcome]]$pseudo_r2$mcfadden
        improvement <- ((reg_r2 - base_r2) / base_r2) * 100
        cat(sprintf(" %14.1f%%", improvement))
      }
    }
    cat("\n")
  }
  
  # Print INCIDENT models
  if(length(incident_models) > 0) {
    cat("\n\n--- INCIDENT MODELS (with Regional Effects) ---\n")
    cat(strrep("-", 100), "\n")
    cat(sprintf("%-30s", "Predictor"))
    for(outcome in names(incident_models)) {
      short_name <- gsub("cleaned_total_|cleaned_|total_", "", outcome)
      cat(sprintf(" %15s", short_name))
    }
    cat("\n")
    cat(strrep("-", 100), "\n")
    
    # Print IRRs
    for(pred in all_predictors) {
      cat(sprintf("%-30s", substr(pred, 1, 30)))
      
      for(outcome in names(incident_models)) {
        if(!is.null(incident_models[[outcome]])) {
          sum_df <- incident_models[[outcome]]$summary
          pred_row <- sum_df[sum_df$term == pred, ]
          
          if(nrow(pred_row) > 0) {
            irr_str <- sprintf("%.3f%s", pred_row$IRR[1], pred_row$stars[1])
            cat(sprintf(" %15s", irr_str))
          } else {
            cat(sprintf(" %15s", "-"))
          }
        }
      }
      cat("\n")
    }
    
    # Add regional effects
    cat(strrep("-", 100), "\n")
    cat("REGIONAL EFFECTS:\n")
    for(reg in c("regionNortheast", "regionMidwest", "regionWest")) {
      cat(sprintf("%-30s", gsub("region", "", reg)))
      for(outcome in names(incident_models)) {
        sum_df <- incident_models[[outcome]]$summary
        pred_row <- sum_df[sum_df$term == reg, ]
        if(nrow(pred_row) > 0) {
          irr_str <- sprintf("%.3f%s", pred_row$IRR[1], pred_row$stars[1])
          cat(sprintf(" %15s", irr_str))
        } else {
          cat(sprintf(" %15s", "-"))
        }
      }
      cat("\n")
    }
    
    # Model fit comparison
    cat(strrep("-", 100), "\n")
    cat(sprintf("%-30s", "Base McFadden R²"))
    for(outcome in names(incident_models)) {
      if(outcome %in% names(base_results)) {
        cat(sprintf(" %15.3f", base_results[[outcome]]$pseudo_r2$mcfadden))
      }
    }
    cat("\n")
    
    cat(sprintf("%-30s", "Regional McFadden R²"))
    for(outcome in names(incident_models)) {
      cat(sprintf(" %15.3f", incident_models[[outcome]]$pseudo_r2$mcfadden))
    }
    cat("\n")
    
    cat(sprintf("%-30s", "Improvement"))
    for(outcome in names(incident_models)) {
      if(outcome %in% names(base_results)) {
        base_r2 <- base_results[[outcome]]$pseudo_r2$mcfadden
        reg_r2 <- incident_models[[outcome]]$pseudo_r2$mcfadden
        improvement <- ((reg_r2 - base_r2) / base_r2) * 100
        cat(sprintf(" %14.1f%%", improvement))
      }
    }
    cat("\n")
  }
  
  cat(strrep("-", 100), "\n")
  cat("Significance: *** p<0.001, ** p<0.01, * p<0.05, † p<0.1\n")
  cat("Regional effects are relative to South (reference category)\n")
}

# Create the enhanced comparison
if(length(regional_all_results) > 0) {
  create_enhanced_comparison(all_nb_results, regional_all_results)
}

# Export regional results
regional_export_df <- data.frame()
for(outcome in names(regional_all_results)) {
  if(!is.null(regional_all_results[[outcome]])) {
    df <- regional_all_results[[outcome]]$summary
    df$outcome <- outcome
    df$model_type <- "Regional"
    regional_export_df <- rbind(regional_export_df, df)
  }
}

write.csv(regional_export_df, 
          paste0(save_path, "nb_regional_all_outcomes_results.csv"), 
          row.names = FALSE)

cat("\n\n✓ Regional results exported to: nb_regional_all_outcomes_results.csv\n")
